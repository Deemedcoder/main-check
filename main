import json
import requests
from pysnmp.hlapi import *
import subprocess
import platform
import time

# API URL
url = "http://192.168.1.41:81/test-soft/api.php"


def fetch_api_data(url):
    """
    Fetches JSON data from a given API URL.
    """
    try:
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            return data
        else:
            print(f"Failed to get data. Status code: {response.status_code}")
            return None
    except Exception as e:
        print(f"Error fetching API data: {e}")
        return None


# Ping function
def ping_device(hostname, timeout=1, count=1):
    """
    Pings a device to check its reachability.
    """
    try:
        param = '-n' if platform.system().lower() == 'windows' else '-c'
        timeout_param = '-w' if platform.system().lower() == 'windows' else '-W'
        command = ["ping", param, str(count), timeout_param, str(timeout), hostname]
        output = subprocess.run(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        return output.returncode == 0
    except Exception as e:
        print(f"Error pinging device: {e}")
        return False


# SNMP GET function
def snmp_get(ip, port, community, *oids):
    try:
        object_types = [ObjectType(ObjectIdentity(oid)) for oid in oids]
        errorIndication, errorStatus, errorIndex, varBinds = next(
            getCmd(SnmpEngine(),
                   CommunityData(community, mpModel=1),
                   UdpTransportTarget((ip, port)),
                   ContextData(),
                   *object_types))

        if errorIndication:
            print(f"Error Indication: {errorIndication}")
            return [None] * len(oids)
        elif errorStatus:
            print(f"Error Status: {errorStatus.prettyPrint()} at {errorIndex}")
            return [None] * len(oids)
        else:
            return [varBind[1].prettyPrint() for varBind in varBinds]
    except Exception as e:
        print(f"Exception in SNMP GET: {e}")
        return [None] * len(oids)


# Function to process the data and query SNMP
def process_data_and_query_snmp(data_dict):
    result = {}

    if not isinstance(data_dict, dict):
        raise ValueError("Expected 'data_dict' to be a dictionary.")

    for hostname, device_data in data_dict.items():
        if not isinstance(device_data, dict):
            print(f"Expected a dictionary for device data: {device_data}")
            continue

        ip = device_data.get("ip")
        port = device_data.get("port", 161)
        community = device_data.get("community_string")
        oids_str = device_data.get("oids")

        print(f"Processing device: {hostname} ({ip})")

        if not ping_device(ip):
            print(f"Device {hostname} ({ip}) is not reachable. Skipping SNMP check.")
            continue

        print(f"Device {hostname} ({ip}) is reachable. Proceeding with SNMP check.")

        try:
            oids_dict = json.loads(oids_str)
        except json.JSONDecodeError as e:
            print(f"Error decoding OID string: {e}")
            continue

        oids = list(oids_dict.values())
        oids_name = list(oids_dict.keys())

        snmp_values = snmp_get(ip, port, community, *oids)

        device_result = {}
        for oid, value in zip(oids_name, snmp_values):
            device_result[oid] = value

        result[hostname] = device_result

    return result


# Main function to continuously run the program
def run_continuously():
    while True:
        try:
            # Fetch data from the API
            data = fetch_api_data(url)
            if data:
                final_result = process_data_and_query_snmp(data)

                # Convert the result to JSON format
                json_result = json.dumps(final_result, indent=4)

                print("Final Result (JSON):")
                print(json_result)

                # API endpoint where you want to post the result
                api_url = 'http://192.168.1.41:81/test-soft/update_api.php'

                # Send the POST request with the result data
                headers = {'Content-Type': 'application/json'}
                response = requests.post(api_url, headers=headers, data=json_result)

                print("API Response Status Code:", response.status_code)
                print("API Response Body:", response.text)

            else:
                print("No data fetched from the API.")
        except Exception as e:
            print(f"An error occurred: {e}")

        # Wait for a certain amount of time before running again (e.g., 60 seconds)
        time.sleep(60)


if __name__ == "__main__":
    run_continuously()
